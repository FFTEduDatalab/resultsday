<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'/>
  <link rel='stylesheet' type='text/css' href='../../styles.css'>
  <script src='https://code.highcharts.com/highcharts.js'></script>
  <script src='https://code.highcharts.com/modules/series-label.js'></script>
  <script src='https://code.highcharts.com/modules/exporting.js'></script>
  <script src='https://code.highcharts.com/modules/export-data.js'></script>
  <script src='https://code.highcharts.com/modules/data.js'></script>
  <script src='/theme.js'></script>
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
</head>
<body>
  <select id='breakdownSelector' autocomplete='off'>
      <option value='coverage'>Coverage</option>
      <option value='age'>Age</option>
  </select>
  <select id='scopeSelector' autocomplete='off' onchange='scopeOptionChange()'>
    <option value='UK'>UK</option>
    <option value='EN'>England</option>
    <option value='WA'>Wales</option>
    <option value='NI'>Northern Ireland</option>
  </select>
  <div id='entriesChartContainer' class='chartContainer'></div>
  <select id='gradesSelector' autocomplete='off' onchange='gradeChartOptionChange()'>
      <option value='Selected'>Selected grades</option>
      <option value='All'>All grades</option>
  </select>
  <select id='genderSelector' autocomplete='off' onchange='gradeChartOptionChange()'>
      <option value='All students'>All students</option>
      <option value='Male'>Male</option>
      <option value='Female'>Female</option>
  </select>
  <div id='gradesChartContainer' class='chartContainer'></div>
  <div id='textContainer'></div>
    <script>
      var level='GCSE'
      var alias = 'CHEM';
      var subject = '';
      var breakdown = 'Coverage';
      var scope = 'UK';
      var grades = 'Selected'
      var gender = 'All students'
      var entriesData=[]
      var gradesData=[]
      var entriesChartSubtitle
      var gradesChartSubtitle
      var gradesChartColoursArray = []
      var subjectsJSON=''
      var entriesJSON=''
      var gradesJSON=''
      var textJSON=''
      var gradesAll=[]
      var gradesSelected=[]
      var coloursDict = {
          'All students':'#535353',
          'Male':'#2daae1',
          'Female':'#96c11f'
      }
      var levels=[
      	{
      		'name':'A-Level',
          'subjectsJSON':'a-level-subjects.json',
          'entriesJSON':'a-level-entries.json',
          'gradesJSON':'a-level-grades.json',
          'textJSON':'a-level-text.json',
          'gradesAll':['A*','A','B','C','D','E','U'],
          'gradesSelected':['A*','A','C','E']
      	},
      	{
      		'name':'AS-Level',
          'subjectsJSON':'as-level-subjects.json',
          'entriesJSON':'as-level-entries.json',
          'gradesJSON':'as-level-grades.json',
          'textJSON':'as-level-text.json',
      		'gradesAll':['A','B','C','D','E','U'],
          'gradesSelected':['A','C','E']
      	},
      	{
      	 	'name':'GCSE',
          'subjectsJSON':'gcse-subjects.json',
          'entriesJSON':'gcse-entries.json',
          'gradesJSON':'gcse-grades.json',
          'textJSON':'gcse-text.json',
      		'gradesAll':['A/7','C/4','G/1','U'],
          'gradesSelected':['A/7','C/4','G/1']
      	}
      ]

      Highcharts.setOptions(Highcharts.theme)

        $(function () {
          gradesChartColoursArray.push(coloursDict['All students'])
          let levelData=levels.filter(function(levels) {
            return levels.name == level
          })[0];
          subjectsJSON=levelData.subjectsJSON
          entriesJSON=levelData.entriesJSON
          gradesJSON=levelData.gradesJSON
          textJSON=levelData.textJSON
          gradesAll=levelData.gradesAll
          gradesSelected=levelData.gradesSelected
          $.getJSON(subjectsJSON, function(data) {
              let len=data.length
              if(len>0){
                  for(let i=0; i<len; i++){
                      var line=data.shift()
                      if (line.alias == alias){
                        subject=line.subject_name_clean
                      }
                  }
              }
          });
          $.getJSON(textJSON, function(data) {
              let len=data.length
              if(len>0){
                  for(let i=0; i<len; i++){
                      var line=data.shift()
                      if (line.alias == alias){
                        document.getElementById('textContainer').innerHTML=line.text
                      }
                  }
              }
          });
          drawEntriesChart()
          drawGradesChart()
        });

        function readEntriesData() {
            $.getJSON(entriesJSON, function(data) {
              entriesData=[]
              let len=data.length
              if(len>0){
                  for(let i=0; i<len; i++){
                      var line=data.shift()
                      if (line.alias == alias && line.scope == scope){
                        entriesData.push(line)
                      }
                  }
		          }
            });
        };

      function readGradesData() {
        $.getJSON(gradesJSON, function(data) {
          gradesData=[]
          let grades_array=[]
          if(grades == 'Selected'){
            grades_array=gradesSelected
          }
          else if (grades == 'All') {
            grades_array=gradesAll
          }
          let len=data.length
          if(len>0){
              for(let i=0; i<len; i++){
                  var line=data.shift()
                  if (line.alias == alias && line.scope == scope && grades_array.indexOf(line.name)!=-1 && line.gender== gender){
                    gradesData.push(line)
                  }
              }
          }
        });
      };

      function scopeOptionChange() {
        scope = document.getElementById('scopeSelector').value
        drawEntriesChart()
        drawGradesChart()
      }

      function gradeChartOptionChange() {
        grades = document.getElementById('gradesSelector').value
        gender = document.getElementById('genderSelector').value
        drawGradesChart()
      }

      function setChartSubtitles() {
          let scopeDict = {
              'UK':'UK-wide',
              'EN':'England',
              'WA':'Wales',
              'NI':'Northern Ireland',
              '15':'15-year-olds and younger',
              '16':'16-year-olds',
              '17':'17-year-olds and older'
          }
          let gradesDict = {
              'Selected':'selected grades',
              'All':'all grades'
          }
          let genderDict = {
              'All students':'All students',
              'Male':'Male students',
              'Female':'Female students',
          }
          entriesChartSubtitle = 'All students, ' + scopeDict[scope]
          gradesChartSubtitle = genderDict[gender] + ', ' + scopeDict[scope] + ', ' + gradesDict[grades]
          return entriesChartSubtitle, gradesChartSubtitle
      }

      function drawEntriesChart() {
        readEntriesData()
        setChartSubtitles()
        gradesChartColoursArray = []
        gradesChartColoursArray.push(coloursDict[gender])
        var js = document.createElement('script');
        js.setAttribute('type', 'text/javascript');
        js.src = '../../entries_chart.js';
        document.body.appendChild(js)
      }

      function drawGradesChart() {
        readGradesData()
		    setChartSubtitles()
        gradesChartColoursArray = []
        gradesChartColoursArray.push(coloursDict[gender])
        var js = document.createElement('script');
        js.setAttribute('type', 'text/javascript');
        js.src = '../../grades_chart.js';
        document.body.appendChild(js)
      }

      $('#breakdownSelector').change(function () {
        breakdown = $(this).val();
        if (breakdown == 'coverage') {
          $('#scopeSelector').html('<option value="UK">UK</option><option value="EN">England</option><option value="WA">Wales</option><option value="NI">Northern Ireland</option>');
        }
        else if (breakdown == 'age') {
          $('#scopeSelector').html('<option value="UK">All ages</option><option value="15">15-year-olds and younger</option><option value="16">16-year-olds</option><option value="17">17-year-olds and older</option>');
        }
        if(scope!='UK'){
            scope = 'UK'
            drawEntriesChart(scope, grades, gender)
            drawGradesChart(scope, grades, gender)
        }
      });

    </script>
</body>
<html>
